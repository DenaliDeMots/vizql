<!DOCTYPE html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            width: 100%;
            color: #333;
        }

        .link {
            fill: none;
            stroke: #333333;
            stroke-width: 2px;
        }

        table {
            border: 2px solid #333;
            background-color: lightblue;
            border-radius: 3px;
            padding: 0.8rem;
            /* width: 100px; */
        }

        th {
            border-bottom: 2px solid #333;
        }
    </style>
    <title>VizQL</title>
</head>

<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
    let data = { data }

    var svg = d3.select("svg"),
        width = window.innerWidth,
        height = window.innerHeight

    svg.attr("width", window.innerWidth)
    svg.attr("height", window.innerHeight);

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().distance(300).strength(2))
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2));


    // Build the arrow
    svg.append("svg:defs").selectAll("marker")
        .data(["end"])      // Different link/path types can be defined here
        .enter().append("svg:marker")    // This section adds in the arrows
        .attr("id", String)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 15)
        .attr("refY", -1.5)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");


    var nodes = data.schemas,
        nodeById = d3.map(nodes, d => d.name),
        links = data.links

    links.forEach(function (link) {
        link.source = nodeById.get(link.source)
        link.target = nodeById.get(link.target)
    });

    var link = svg.selectAll(".link")
        .data(links)
        .enter().append("path")
        .attr("class", "link")
        .attr("marker-end", "url(#end)"); //add arrow

    var node = svg.selectAll(".node")
        .data(nodes)
        .enter().append("foreignObject")
        .attr("class", "node")
        .attr("width", 50)
        .attr('height', 50)
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

    var table = node
        .append('xhtml:table')

    //add table name
    table
        .append('xhtml:tr')
        .append('xhtml:th')
        .attr('colspan', 2)
        .text(t => t.name)

    let row = table.selectAll('.child').data(d => d.columns).enter().append('tr')
    row.append('td').text(d => d.content)
    row.append('td').text(d => d.type)

    simulation
        .nodes(nodes)
        .on("tick", ticked);


    simulation.force("link")
        .links(links);

    function ticked() {
        link.attr("d", positionLink);
        node.attr("transform", positionNode);
    }

    function positionLink(d) {
        const sx = d.source.x
        const sy = d.source.y + parseInt(node.style("width")) * 2;
        const tx = d.target.x
        const ty = d.target.y + parseInt(node.style("width"));
        const midpoint = Math.abs(tx - sx) + (tx < sx ? tx : sx)
        return `M ${sx} ${sy},
            C ${midpoint} ${sy},
            ${midpoint} ${ty},
            ${tx} ${ty}`
        //     return "M" + d[0].x + "," + d[0].y
        //         + "S" + d[1].x + "," + d[1].y
        //         + " " + d[2].x + "," + d[2].y;
    }

    function positionNode(d) {
        return "translate(" + d.x + "," + d.y + ")";
    }

    function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x, d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x, d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null, d.fy = null;
    }

</script>